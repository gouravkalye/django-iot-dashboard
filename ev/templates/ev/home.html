{% extends 'ev/base.html' %}

{% block title %}Home - EV Charger{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="card shadow-lg mb-4">
    <div class="card-header bg-primary text-white text-center">
        <h2>EV Station Status</h2>
    </div>
    <div class="card-body">
        <table class="table table-striped table-bordered">
            <tbody>
                <tr>
                    <th scope="row">Station Name</th>
                    <td id="station-name">{{ stations.name}}</td>
                </tr>
                <tr>
                    <th scope="row">Address</th>
                    <td id="station-address">{{ stations.address }}</td>
                </tr>
                <tr>
                    <th scope="row">Station Time</th>
                    <td id="server-time">Loading...</td>
                </tr>
                <tr>
                    <th scope="row">Charge Voltage</th>
                    <td id="soc-temp">Loading...</td>
                </tr>
                <tr>
                    <th scope="row">Charge Current</th>
                    <td id="gpu-temp">Loading...</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Chart Container -->
<div class="card shadow-lg">
    <div class="card-header bg-secondary text-white text-center">
        <h4>Charging Status</h4>
    </div>
    <div class="card-body">
        <canvas id="tempChart"></canvas>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const timeLabels = [];  // Stores time values (1-minute window)
    const socTemps = [];    // Stores SoC temperatures
    const gpuTemps = [];    // Stores GPU temperatures

    const ctx = document.getElementById("tempChart").getContext("2d");

    const tempChart = new Chart(ctx, {
        type: "line",
        data: {
            labels: timeLabels,
            datasets: [
                {
                    label: "EV charge voltage",
                    data: socTemps,
                    borderColor: "red",
                    backgroundColor: "rgba(255, 0, 0, 0.2)",
                    fill: true,
                    tension: 0.4
                },
                {
                    label: "EV charge current",
                    data: gpuTemps,
                    borderColor: "blue",
                    backgroundColor: "rgba(0, 0, 255, 0.2)",
                    fill: true,
                    tension: 0.4
                }
            ]
        },
        options: {
            responsive: true,
            animation: {
                duration: 500,
                easing: "easeInOutQuad"
            },
            scales: {
                x: {
                    title: { display: true, text: "Time (Last 1 min)" },
                    ticks: {
                        maxTicksLimit: 10
                    }
                },
                y: { 
                    title: { display: true, text: "voltage & current" }, 
                    ticks: { stepSize: 5 }, 
                    beginAtZero: false
                }
            }
        }
    });

    function updateServerInfo() {
        fetch("/server-info/")
            .then(response => response.json())
            .then(data => {
                document.getElementById("server-time").textContent = data.server_time;

                const socTemp = data.voltage_info || 0;
                const gpuTemp = data.current_info || 0;

                document.getElementById("soc-temp").textContent = `${(socTemp * 2).toFixed(1)}V`;
                document.getElementById("gpu-temp").textContent = `${(gpuTemp / 10).toFixed(1)}A`;

                const currentTime = new Date().toLocaleTimeString();

                if (timeLabels.length >= 60) {
                    timeLabels.shift();
                    socTemps.shift();
                    gpuTemps.shift();
                }

                timeLabels.push(currentTime);
                socTemps.push((socTemp*2).toFixed(2));
                gpuTemps.push(parseFloat((gpuTemp / 10).toFixed(2)));

                // Dynamically adjust Y-axis
                const minTemp = Math.min(...socTemps, ...gpuTemps);
                const maxTemp = Math.max(...socTemps, ...gpuTemps);
                tempChart.options.scales.y.min = Math.floor(minTemp / 5) * 5 - 5;
                tempChart.options.scales.y.max = Math.ceil(maxTemp / 5) * 5 + 5;

                tempChart.update("none");
            })
            .catch(error => console.error("Error fetching server info:", error));
    }

    setInterval(updateServerInfo, 1000);
    document.addEventListener("DOMContentLoaded", updateServerInfo);
</script>
{% endblock %}

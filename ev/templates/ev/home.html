{% extends 'ev/base.html' %}
{% load static %}

{% block title %}Home - EV Charger{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<link rel="stylesheet" href="{% static 'ev/css/styles.css' %}">
<link rel="stylesheet" href="{% static 'ev/css/chart.css' %}">
<style>
    .status-card {
        transition: transform 0.2s;
    }
    .status-card:hover {
        transform: translateY(-5px);
    }
    .chart-container {
        position: relative;
        height: 300px;
        margin-bottom: 2rem;
    }
    .station-status {
        font-size: 0.9rem;
    }
    .station-status.available {
        color: #28a745;
    }
    .station-status.unavailable {
        color: #dc3545;
    }
    .server-info-card {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="display-4 text-center mb-3">EV Charging Dashboard</h1>
            <p class="lead text-center text-muted">Monitor your charging stations in real-time</p>
        </div>
    </div>

    <!-- Main Content -->
    <div class="row">
        <!-- Left Column - Station Status -->
        <div class="col-md-4 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-lightning-charge-fill me-2"></i>
                        Station Status
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Current Station Info -->
                    <div class="current-station mb-4 p-3 bg-light rounded">
                        <h6 class="text-muted mb-2">Currently Selected Station</h6>
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5 id="current-station-name" class="mb-1">No station selected</h5>
                                <p id="current-station-location" class="text-muted mb-0 small">Select a station to begin charging</p>
                            </div>
                            <span id="current-station-status" class="badge bg-secondary">Inactive</span>
                        </div>
                    </div>

                    <!-- All Stations List -->
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Station</th>
                                    <th>Status</th>
                                    <th>Location</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for station in stations %}
                                <tr class="station-row" data-station-id="{{ station.id }}" 
                                    data-station-name="{{ station.name }}"
                                    data-station-location="{{ station.city }}, {{ station.state }}">
                                    <td>{{ station.name }}</td>
                                    <td>
                                        <span class="station-status {% if station.is_available %}available{% else %}unavailable{% endif %}">
                                            <i class="bi {% if station.is_available %}bi-check-circle-fill{% else %}bi-x-circle-fill{% endif %}"></i>
                                            {% if station.is_available %}Available{% else %}In Use{% endif %}
                                        </span>
                                    </td>
                                    <td>{{ station.city }}, {{ station.state }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Middle Column - EV Station Info -->
        <div class="col-md-4 mb-4">
            <div class="card shadow-sm h-100 server-info-card">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-lightning-charge me-2"></i>
                        EV Station Information
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table">
                            <tbody>
                                <tr>
                                    <th>Station Time:</th>
                                    <td id="station-time">Loading...</td>
                                </tr>
                                <tr>
                                    <th>Charging Voltage:</th>
                                    <td id="charging-voltage">Loading...</td>
                                </tr>
                                <tr>
                                    <th>Charging Current:</th>
                                    <td id="charging-current">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-3">
                        <button id="startCharging" class="btn btn-success w-100 mb-2">
                            <i class="bi bi-play-fill me-2"></i>Start Charging
                        </button>
                        <button id="stopCharging" class="btn btn-danger w-100" disabled>
                            <i class="bi bi-stop-fill me-2"></i>Stop Charging
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column - Quick Actions -->
        <div class="col-md-4 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-success text-white">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-lightning-charge me-2"></i>
                        Quick Actions
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{% url 'station' %}" class="btn btn-primary">
                            <i class="bi bi-search me-2"></i>Find Charging Station
                        </a>
                        <a href="{% url 'user_profile' %}" class="btn btn-outline-primary">
                            <i class="bi bi-person me-2"></i>View Profile
                        </a>
                        <a href="{% url 'recharge_account' %}" class="btn btn-outline-success">
                            <i class="bi bi-credit-card me-2"></i>Recharge Account
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Chart Section -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-dark text-white">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-graph-up me-2"></i>
                        Charging Status
                    </h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="chargingChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    let isCharging = false;
    let voltage = 230;
    let current = 15;
    let currentStation = null;

    // Station selection handling
    document.querySelectorAll('.station-row').forEach(row => {
        row.addEventListener('click', function() {
            // Update current station
            currentStation = {
                id: this.dataset.stationId,
                name: this.dataset.stationName,
                location: this.dataset.stationLocation,
                isAvailable: this.querySelector('.station-status').classList.contains('available')
            };

            // Update display
            document.getElementById('current-station-name').textContent = currentStation.name;
            document.getElementById('current-station-location').textContent = currentStation.location;
            
            // Update status badge
            const statusBadge = document.getElementById('current-station-status');
            if (currentStation.isAvailable) {
                statusBadge.className = 'badge bg-success';
                statusBadge.textContent = 'Available';
                document.getElementById('startCharging').disabled = false;
            } else {
                statusBadge.className = 'badge bg-danger';
                statusBadge.textContent = 'In Use';
                document.getElementById('startCharging').disabled = true;
            }

            // Highlight selected row
            document.querySelectorAll('.station-row').forEach(r => r.classList.remove('table-primary'));
            this.classList.add('table-primary');
        });
    });

    // Initialize chart
    const ctx = document.getElementById('chargingChart').getContext('2d');
    const chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [
                {
                    label: 'Voltage (V)',
                    data: [],
                    borderColor: 'rgb(255, 99, 132)',
                    tension: 0.1,
                    fill: false,
                    yAxisID: 'y'
                },
                {
                    label: 'Current (A)',
                    data: [],
                    borderColor: 'rgb(54, 162, 235)',
                    tension: 0.1,
                    fill: false,
                    yAxisID: 'y1'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: 'Voltage (V)'
                    },
                    min: 220,
                    max: 260
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: 'Current (A)'
                    },
                    min: 14,
                    max: 17,
                    grid: {
                        drawOnChartArea: false
                    }
                }
            }
        }
    });

    // Update station information
    function updateServerInfo() {
        // Generate random values within range
        if (isCharging && currentStation) {
            voltage = 230 + Math.random() * 20; // Random between 230-250
            current = 15 + Math.random(); // Random between 15-16
        } else {
            voltage = 0;
            current = 0;
        }

        // Update display
        document.getElementById('station-time').textContent = new Date().toLocaleTimeString();
        document.getElementById('charging-voltage').textContent = voltage.toFixed(1) + ' V';
        document.getElementById('charging-current').textContent = current.toFixed(1) + ' A';
        
        // Update chart
        const time = new Date().toLocaleTimeString();
        
        // Add new data points
        chart.data.labels.push(time);
        chart.data.datasets[0].data.push(voltage);
        chart.data.datasets[1].data.push(current);
        
        // Keep only last 20 data points
        if (chart.data.labels.length > 20) {
            chart.data.labels.shift();
            chart.data.datasets[0].data.shift();
            chart.data.datasets[1].data.shift();
        }
        
        // Update chart
        chart.update('none');
    }

    // Start/Stop charging buttons
    document.getElementById('startCharging').addEventListener('click', function() {
        if (!currentStation) {
            alert('Please select a station first');
            return;
        }
        isCharging = true;
        this.disabled = true;
        document.getElementById('stopCharging').disabled = false;
        
        // Update station status
        const statusBadge = document.getElementById('current-station-status');
        statusBadge.className = 'badge bg-warning';
        statusBadge.textContent = 'Charging';
    });

    document.getElementById('stopCharging').addEventListener('click', function() {
        isCharging = false;
        this.disabled = true;
        document.getElementById('startCharging').disabled = false;
        
        // Update station status
        const statusBadge = document.getElementById('current-station-status');
        statusBadge.className = 'badge bg-success';
        statusBadge.textContent = 'Available';
    });

    // Update every second
    setInterval(updateServerInfo, 1000);
    updateServerInfo(); // Initial update
</script>
{% endblock %}
